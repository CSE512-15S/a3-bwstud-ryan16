<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>A3</title>

  <style>
    html, body { width: 100%; height: 100%; margin: 0; } 
   
    .pt {
      fill: red;
    }

    #vis {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100%;
      width: 100%;
      background-color: black;
    }

    .orbit {
      fill: none;
      stroke: rgba(0, 255, 255, 0.25);
    }

    .sun {
      fill: yellow;
    }

    .distance-axis {
      opacity: 0.25;
    }

    .distance-axis text {
      fill: white;
    }

    .distance-axis .tick line {
      stroke: white;
      stroke-width: 1px;
    }

    .distance-axis .domain { stroke: white; fill: none; }
  </style>
</head>
<body>
  <svg id="vis"></svg>
  <script src="lib/d3.min.js"></script>
  <script src="lib/timbre.js"></script>
  <script>
    var notes = ['A', 'A#/Bb', 'B', 'C', 'C#/Db', 'D', 'D#/Eb', 'E', 'F', 'F#/Gb', 'G', 'G#/Ab'];    
    var note = function(freq) {
      return notes[(Math.round(12*(Math.log(freq/440) / Math.log(2))))%12];
    }

    console.log(note(1232));

    var synth = T("OscGen", {wave:"sin", mul:0.5});

    T("interval", {interval: 300, timeout:"5sec"}, function() {
        synth.noteOnWithFreq(400, 80);
    }).on("ended", function() {
        this.stop();
    }).set({buddies:synth}).start();

    T("interval", {interval: 400, timeout:"5sec"}, function() {
        synth.noteOnWithFreq(300, 80);
    }).on("ended", function() {
        this.stop();
    }).set({buddies:synth}).start();


    T("interval", {interval: 100, timeout:"5sec"}, function() {
        synth.noteOnWithFreq(800, 80);
    }).on("ended", function() {
        this.stop();
    }).set({buddies:synth}).start();

    var sun = {
      r: 695500,
      "color": "yellow",
      "moons": [
        {"name":"Mercury", "ap": 69816900, "r": 2439.7, "color": "#999", "moons":[]},
        {"name":"Venus", "ap": 108939000, "r": 6051.8, "color": "#EA0", "moons":[]},
        {
          "name":"Earth",
          "ap": 151930000,
          "r": 6371.0,
          "color": "#03F",
          "moons": [
            {"name":"Moon (Luna)", "ap":405400, "r": 1737.10, "color":"#999", "period":27.321582}
          ]
        },
        {
          "name":"Mars",
          "ap": 249.2e6,
          "r": 3389.5,
          "color": "#F00",
          "moons": [
            {"name": "Phobos", "r":11.1, "ap":9377, "color":"#B66", "period":0.31891023},
            {"name": "Diemos", "r":6.2, "ap":23460, "color":"#B66", "period":1.263}
          ]
        },
        {
          "name":"Jupiter",
          "ap": 816520800,
          "r": 69911,
          "color": "#FA1",
          "moons": [
            {
              "name": "Io",
              "r": 1821.6,
              "ap":421700,
              "color":"#fc0",
              "period":1.7691
            },
            {
              "name": "Europa",
              "r": 1560.8,
              "ap": 671034,
              "color": "#f60",
              "period": 3.5512
            },
            {
              "name": "Ganymede",
              "r": 2631.2,
              "ap": 1070412,
              "color": "gray",
              "period": 7.1546
            },
            {
              "name": "Callisto",
              "r": 2410.3,
              "ap": 1882709,
              "color": "#A6A",
              "period": 16.689
            },
            {
              "name": "Amalthea",
              "r": 83.45,
              "ap": 181366,
              "color": "gray",
              "period": 0.49817943
            },
            {
              "name": "Thebe",
              "r": 49.3,
              "ap": 221889,
              "color": "gray",
              "period": 0.674536
            },
            {
              "name": "Adrastea",
              "r": 8.2,
              "ap": 128690,
              "color": "gray",
              "period": 0.29826
            },
            {
              "name": "Metis",
              "r": 21.5,
              "ap": 127690,
              "color": "gray",
              "period": 0.294780
            }
          ]      
        },
        {
          "name":"Saturn",
          "ap": 1513325783,
          "r": 58232,
          "color": "#FD1",
          "rings": true,
          "moons": [
            {
              "name": "Mimas",
              "r": "198",
              "ap": "185539",
              "period": "0.942422",
              "color": "gray"
            },
            {
              "name": "Enceladus",
              "r": "252",
              "ap": "237948",
              "period": "1.370218",
              "color": "#77F"
            },
            {
              "name": "Tethys",
              "r": "531",
              "ap": "294619",
              "period": "1.887802",
              "color": "gray"
            },
            {
              "name": "Dione",
              "r": "561.5",
              "ap": "377396",
              "period": "2.736915",
              "color": "gray"
            },
            {
              "name": "Rhea",
              "r": "763.5",
              "ap": "527108",
              "period": "4.518212",
              "color": "gray"
            },
            {
              "name": "Titan",
              "r": "2575",
              "ap": "1221870",
              "period": "15.94542",
              "color": "#d90"
            },
            {
              "name": "Iapetus",
              "r": "735",
              "ap": "3560820",
              "period": "79.3215",
              "color": "#333"
            }
          ]
        },
        {
          "name":"Uranus",
          "ap": 3006224700,
          "r": 25362,
          "color": "#0FF",
          "moons": [
            {
              "name": "Titania",
              "diameter": "1576.8",
              "r": "788.4",
              "ap": "435910",
              "period": "8.705872",
              "color": "gray"
            },
            {
              "name": "Oberon",
              "diameter": "1522.8",
              "r": "761.4",
              "ap": "583520",
              "period": "13.463239",
              "color": "gray"
            },
            {
              "name": "Ariel",
              "diameter": "1157.8",
              "r": "578.9",
              "ap": "191020",
              "period": "2.520379",
              "color": "gray"
            },
            {
              "name": "Umbriel",
              "diameter": "1169.4",
              "r": "584.7",
              "ap": "266300",
              "period": "4.144177",
              "color": "#444"
            },
            {
              "name": "Miranda",
              "diameter": "471.6",
              "r": "235.8",
              "ap": "129390",
              "period": "1.413479",
              "color": "#999"
            },
            {
              "name": "Puck",
              "diameter": "162",
              "r": "81",
              "ap": "86010",
              "period": "0.761833",
              "color": "gray"
            }
          ]        
        },
        {
          "name":"Neptune",
          "ap": 4537580900,
          "r": 24622,
          "color": "#00F",
          "moons": [
            {
              "name": "Naiad",
              "diameter": "66",
              "r": "33",
              "ap": "48227",
              "period": "0.294"
            },
            {
              "name": "Thalassa",
              "diameter": "82",
              "r": "41",
              "ap": "50074",
              "period": "0.311"
            },
            {
              "name": "Despina",
              "diameter": "150",
              "r": "75",
              "ap": "52526",
              "period": "0.335"
            },
            {
              "name": "Galatea",
              "diameter": "176",
              "r": "88",
              "ap": "61953",
              "period": "0.429"
            },
            {
              "name": "Larissa",
              "diameter": "194",
              "r": "97",
              "ap": "73548",
              "period": "0.555"
            },
            {
              "name": "Proteus",
              "diameter": "420",
              "r": "210",
              "ap": "117646",
              "period": "1.122"
            },
            {
              "name": "Triton",
              "diameter": "2705.2",
              "r": "1352.6",
              "ap": "354759",
              "period": "âˆ’5.877"
            }
          ]
        }
      ]
    };

    var currentView = sun.moons[4];


    window.onload = function() {
      var RECT = document.getElementById("vis").getBoundingClientRect();
      var WIDTH = RECT.right - RECT.left;
      var HEIGHT = RECT.bottom - RECT.top;

      var zoom = Math.min(WIDTH/2, HEIGHT/2);

      console.log("w", WIDTH, "h", HEIGHT);

      var ap = function(d) { return d.ap; };

      var r = d3.scale.linear()
        .domain([0, currentView.r])
        .range([1, 30]);

      var svg = d3.select("#vis")
        .append("g") // use a group to translate our coordinates to the center
          .attr("transform", "translate(" + WIDTH/2 + "," + HEIGHT/2 + ")");
      
      svg.append("circle")
        .datum(currentView)
        .attr("fill", function(d) { return d.color||"red"; })
        .attr("r", function(d) { return r(d.r); })
        .attr("cx", 0)
        .attr("cy", 0)

      render();

      document.addEventListener("DOMMouseScroll", function(e) {
        if (e.detail < 0) {
          zoom /= 1.1;
        } else {
          zoom *= 1.1;
        }
        render();
      });

      document.addEventListener("mousemove", function(e) {
        console.log(e.layerX);
      });

      function render() {
        var x = d3.scale.linear()
          .domain([currentView.r, d3.max(currentView.moons, ap)])
          .range([r(currentView.r), zoom]).nice();

        var xAxis = d3.svg.axis().scale(x).ticks(0, "e");

        var pts = svg.selectAll(".pt")
          .data(currentView.moons)

        // distance axis
        svg.select(".distance-axis")
            .attr("class", "distance-axis")
            .call(xAxis);

        // orbit lines
        function orbit(d) {
          d.attr("cx", 0)
          .attr("cy", 0)
          .attr("r", function(d) { return x(d.ap); })
          .attr("class", "orbit")
        }
        var orbits = svg.selectAll(".orbit").data(currentView.moons);
        orbits.call(orbit);
        orbits.enter().append("circle").call(orbit);
        orbits.exit().remove();

        // bodies
        function body(d) {
          var theta = Math.PI;
          d.attr("cx", function(d) { return Math.cos(theta)*x(d.ap); })
           .attr("cy", function(d) { return -Math.sin(theta)*x(d.ap); })
           .attr("r", function(d) { return r(d.r); })
           .attr("class", "pt")
           .attr("style", function(d) { return "fill:" + (d.color || "red"); })
        }
        
        pts.call(body);
        pts.enter().append("circle").call(body);
        pts.exit().remove()
      }

      requestAnimationFrame(function frame() {
        // rendering
        

        requestAnimationFrame(frame);
      });

    };
  </script>
</body>
</html>
