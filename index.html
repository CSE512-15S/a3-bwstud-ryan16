<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>A3</title>
  <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Cutive+Mono' rel='stylesheet' type='text/css'>
  <style>
    html, body { width: 100%; height: 100%; margin: 0; } 
   
    .pt {
      stroke: red;
      fill: none;
      stroke-linecap: round;
    }

    .pt.selected {
      //stroke: rgba(0, 255, 255, 0.15);
      //stroke-width: 12px;
    }

    #preview {
      background-image: url(pics/spin.gif);
      background-color: black;
	    background-repeat: no-repeat;
      background-position: center;
      display:block;
      border:none;
      object-fit: contain;
    }

    #current{
      letter-spacing: 10px;
      text-align: center;
      font-family: 'Montserrat', sans-serif;
      font-size: 1.618em;
    }

    #vis {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100%;
      width: 100%;
      background-color: black;
    }

    .orbit {
      fill: none;
      stroke: rgba(0, 255, 255, 0.25);
      /* stroke-dasharray: 10,10; */
    }

    .orbit.selected {
      /* stroke: rgba(127, 255, 127, 0.25); */
      stroke-dasharray: 1 1;
      stroke-width: 2;
      stroke: rgba(0, 255, 255, 0.5)
    }



    .sun {
      fill: yellow;
    }

    .distance-axis {
      opacity: 0.25;
    }

    .distance-axis text {
      fill: white;
    }

    .distance-axis .tick line {
      stroke: white;
      stroke-width: 1px;
    }

    #tooltip {
      position: absolute;
      top: 20;
      left: 20;
      padding: 3em;
      color: white;
      background: none;
      font-family: 'Cutive Mono';
      font-size: .618em;
    }

    #info{
      background-color: rgba(0, 0, 0, .5);
    }

    .distance-axis .domain { stroke: white; fill: none; }
  </style>
</head>
<body>
  <svg id="vis"></svg>
  <div id="tooltip">
    <div id="current"></div>
    <img id="preview" width=200 height=200 alt="Satellite Name"/>
    <div id="info"></div>
  </div>
  <script src="lib/d3.min.js"></script>
  <script src="lib/timbre.js"></script>
  <script src="data.js"></script>
  <script src="sound.js"></script>
  <script>
    var currentView = sun.satellites[7];
    window.onload = function() {
      var RECT, WIDTH, HEIGHT, zoom;

      var svg = d3.select("#vis")
        .append("g") // use a group to translate our coordinates to the center
          .attr("class", "container")

      // resize the visualization
      window.addEventListener('resize', handleResize);
      function handleResize() {
        RECT = document.getElementById("vis").getBoundingClientRect();
        WIDTH = RECT.right - RECT.left;
        HEIGHT = RECT.bottom - RECT.top; 
        d3.select(".container")
          .attr("transform", "translate(" + WIDTH/2 + "," + HEIGHT/2 + ")");
      }
      handleResize();
      zoom = 0.9*Math.min(WIDTH/2, HEIGHT/2);

      var ap = function(d) { return d.ap; };

      var r = d3.scale.linear()
        .domain([0, currentView.r])
        .range([1, 30]);

      var dist = d3.scale.linear()
      
      svg.append("circle")
        .datum(currentView)
        .attr("fill", function(d) { return d.color||"red"; })
        .attr("r", function(d) { return r(d.r); })
        .attr("cx", 0)
        .attr("cy", 0)

      render();

      document.addEventListener("DOMMouseScroll", handleWheel);
      document.addEventListener("mousewheel", handleWheel);
      function handleWheel(e) {
        var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
        if (delta < 0) {
          zoom /= 1.1;
        } else {
          zoom *= 1.1;
        }
        render();
        positions();
        handleMouseMove(currentMouseEvent);
        e.preventDefault();
      }

      function tooltip() {
        
      }

      var minBody;
      var currentMouseEvent;
      document.addEventListener("mousemove", handleMouseMove);
      function handleMouseMove(e) {
        currentMouseEvent = e;
        var x = e.layerX - WIDTH/2,
            y = e.layerY - HEIGHT/2,
            r = Math.sqrt(x*x + y*y);
        var mouseDist = dist.invert(r);
        var min;
        var minData;
        if (mouseDist < currentView.r || currentView.satellites.length == 0) {
          minBody = currentView.name;
          minData = currentView;
        } else currentView.satellites.forEach(function(body) {
          if (min == null) {
            min = Math.abs(body.ap - mouseDist);
            minBody = body.name;
            minData = body;
          } else if (Math.abs(body.ap - mouseDist) < min) {
            min = Math.abs(body.ap - mouseDist);
            minBody = body.name;
            minData = body;
          }
        });
        if (minBody) {
          d3.select("#current").html(minBody.toUpperCase());
          d3.select("#preview")
            .attr("src", "pics/" + minBody.toLowerCase() + ".jpg")
            .attr("alt", minBody);
          d3.select("#info").html("<strong>Radius:</strong> " + minData.r + " km" + (!minData.period ?"": ("<br /><strong>Orbital period:</strong> " + minData.period + " days<br/><strong>Apoapsis:</strong> " + minData.ap + " km")));
          d3.selectAll(".orbit").attr("class", function(d) { return d.name === minBody ? "orbit selected" : "orbit"; })
          d3.selectAll(".pt").attr("class", function(d) { return d.name === minBody ? "pt selected" : "pt"; })
        }
      }

      function render() {
       dist.domain([currentView.r, d3.max(currentView.satellites, ap)])
           .range([r(currentView.r), zoom]);

        var pts = svg.selectAll(".pt")
          .data(currentView.satellites);
        var gradients = svg.selectAll(".gradient")
          .data(currentView.satellites);

        // orbit lines
        function orbit(d) {
          d.attr("r", function(d) { return dist(d.ap); })
        }
        var orbits = svg.selectAll(".orbit").data(currentView.satellites);
        orbits.call(orbit);
        orbits.enter()
          .append("circle")
          .attr("class", "orbit")
          .attr("cx", 0)
          .attr("cy", 0)
          .call(orbit);
        orbits.exit().remove();

        //gradients
        var grad = gradients.enter().append("linearGradient")
          .attr("id", function(_,i) { return "grad" + i })
          .attr("class", "gradient")
          .attr("gradientUnits", "userSpaceOnUse")
        grad.append("stop")
          .attr("stop-color", function(d) { return d.color || 'red'; })
          .attr("offset", "0%");
        grad.append("stop")
          .attr("stop-color", function(d) { return d.color || 'red'; })
          .attr("offset", "100%")
          .attr("stop-opacity", "0")
          

        // bodies
        pts.enter().append("path")
           .attr("class", "pt")
           .attr("style", function(d, i) { return "stroke: url(#grad" + i + "); stroke-width:" + 2*r(d.r) + "px"; })
        pts.exit().remove()
      }

      var t = 0;
      var dt = 0.01;

      var pts = d3.selectAll(".pt");
      var orbits = d3.selectAll(".orbit");
      var gradients = d3.selectAll(".gradient");

      var tailLengths = 2;
      function positions() {
        gradients.each(function(d) {
          var rVal = dist(d.ap);
          var theta = t/d.period;
          var theta2 = (t-tailLengths*dt)/d.period;
          var x1 = Math.cos(theta)*rVal,
              y1 =-Math.sin(theta)*rVal,
              x2 = Math.cos(theta2)*rVal,
              y2 =-Math.sin(theta2)*rVal;

          d3.select(this)
            .attr("x1", x1)
            .attr("y1", y1)
            .attr("x2", x2)
            .attr("y2", y2)
        });
        pts.each(function(d) {
          var rVal = dist(d.ap);
          var theta = t/d.period;
          var theta2 = (t-tailLengths*dt)/d.period;
          var x1 = Math.cos(theta)*rVal,
              y1 =-Math.sin(theta)*rVal,
              x2 = Math.cos(theta2)*rVal,
              y2 =-Math.sin(theta2)*rVal;
          var dx = x2-x1, dy = y2-y1;
          d3.select(this).attr('d', "M " + x1 + " " + y1 + 
            " A"+rVal+","+rVal+ " 0 0 " + (d.period > 0 ? 1: 0) + " " + x2 + " " + y2);
        });
      }
      requestAnimationFrame(function frame() {
        // rendering
        t += dt;    
        positions();

        requestAnimationFrame(frame);
      });

    };
  </script>
</body>
</html>
